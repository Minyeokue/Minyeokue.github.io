---
title: 윈도우 서버 실습 2 - Hyper-V 가상 머신들로 수업 복습 및 VLAN 그리고 Hyper-V Live Migration 실습
excerpt: 
author: minyeokue
date: 2024-04-22 17:48:54 +0900
last_modified_at: 2024-04-24 22:15:49 +0900
categories: [Exercise]
tags: [Windows, Hyper-V, Live-Migration, Firewall, Network, Active Directory]

toc: true
toc_sticky: true
---

<br>

Window Server에서 Hyper-V 가상화로 지난 수업들을 복습하고, 가상 머신들을 실시간 복제(Live Migration)하며 핵심 기능을 학습한다.

<br>

---

## 시나리오

<br>

- [기본 환경 구성](#기본-환경-구성)

- DC1

    - Domain Controller

    - [저장소 공유](#저장소-공유)

- SVR1 & SVR2

    - Hyper-V 호스트

    - [가상 컴퓨터 생성](#가상-컴퓨터-생성)

        - [Hyper-V 설정](#hyper-v-설정)    

    - [NAT 구성](#nat-구성)

        - [Windows Server 2003 Telnet 서비스 설정](#windows-server-2003-telnet-서비스-설정)

        - [Windows Server 2003 Telnet 원격 데스크톱 연결](#windows-server-2003-telnet-원격-데스크톱-연결)

        - [NAT 포트포워딩](#nat-포트포워딩)

            - [테스트 - Telnet 접속](#테스트---telnet-접속)

            - [테스트 - 원격 데스크톱 연결](#테스트---원격-데스크톱-연결)

    - [VLAN 구성](#vlan-구성)

    - [Hyper-V 핵심기능](#hyper-v-핵심기능)

        - [Hyper-V Shared Nothing Migration](#hyper-v-shared-nothing-migration)

        - [Hyper-V SMB Live Migration](#hyper-v-smb-live-migration)

        - [Hyper-V Storage Live Migration](#hyper-v-storage-live-migration)

        - [Hyper-V Replication](#hyper-v-replication)
    
    - [NFS 공유 및 웹 서버](#nfs-공유-및-웹-서버)

        - [NFS 클라이언트](#nfs-클라이언트)

<br>

---

### 기본 환경 구성

<br>

기본적으로 Hyper-V를 실행하려면 관련 설정이 필요하다.

메모리와 CPU 코어 개수를 조정하고, 가상 CPU의 가상화 기능을 켜줘야 Hyper-V를 설치할 수 있다.

![가상머신 메모리 추가](/assets/img/2024-04-22/1.png)
_가상머신 메모리 추가_

![가상머신 CPU 추가 및 가상화 기능 활성화](/assets/img/2024-04-22/2.png)
_가상머신 CPU 추가 및 가상화 기능 활성화_

<br>

이후 가상머신의 환경설정을 저장하는 파일의 수정이 필요하다.

해당 VMware가 저장된 폴더로 이동한 뒤 `가상머신명.vmx`{:.filepath} 파일을 수정한다.

![가상머신 설정 파일 수정](/assets/img/2024-04-22/3.png)
_가상머신 설정 파일 수정_

맨 아래에 `hypervisor.cpuid.v0 = "FALSE"`를 추가한다.

<br>

본격적인 설치하기 전, 가상머신들과 가상 하드디스크들이 저장될 폴더를 생성하겠다.

![가상머신 저장 폴더 생성](/assets/img/2024-04-22/4.png)
_가상머신 저장 폴더 생성_

`C:\Hyper-V`{:.filepath} 폴더를 생성하고 그 안에 `C:\Hyper-V\VHDs`{:.filepath}를 생성한다.

<br>

Hyper-V 호스트도 역시 Active Directory 환경이어야 한다. 핵심 기능을 사용하는 데 있어 인증 절차를 Domain Controller에 위임하는 경우가 생기기 때문이다.

그것은 추후 실제 실습에서 설명하도록 하고, DC1은 Active Directory 서비스가 설치된 스냅샷으로 롤백하고, SVR1과 SVR2에 Hyper-V 관리자를 설치한 이후 Domain에 가입시킨다.

먼저 Hyper-V 기능을 추가한다.

![역할 및 기능 추가 위치](/assets/img/2024-04-22/5.png)
_역할 및 기능 추가 위치_

![Hyper-V 기능 추가 1](/assets/img/2024-04-22/6.png)
_Hyper-V 기능 추가 1_

![Hyper-V 기능 추가 2](/assets/img/2024-04-22/7.png)
_Hyper-V 기능 추가 2_

<br>

![Hyper-V 기능 추가 3](/assets/img/2024-04-22/8.png)
_Hyper-V 기능 추가 3_

위 단계까지 **다음** 버튼을 누르고, 이후 Ethernet0를 선택하고 **다음** 버튼을 누른다.

<br>

![Hyper-V 기능 추가 4](/assets/img/2024-04-22/9.png)
_Hyper-V 기능 추가 4_

*실시간 마이그레이션* 단계는 Hyper-V의 핵심 기능이지만, 추후에 설명하도록 하고 지금은 **다음** 버튼을 눌러서 설치를 진행하겠다.

<br>

![Hyper-V 기능 추가 5](/assets/img/2024-04-22/10.png)
_Hyper-V 기능 추가 5_

아까 생성했던 폴더들을 지정한 뒤 **다음** 버튼을 누른다.

<br>

![Hyper-V 기능 추가 설치](/assets/img/2024-04-22/11.png)
_Hyper-V 기능 추가 설치_

위 단계까지 진행한 뒤, **설치** 버튼을 누른다. 잠시 기다린다.

<br>

![Hyper-V 기능 추가 후 다시 시작](/assets/img/2024-04-22/12.png)
_Hyper-V 기능 추가 후 다시 시작_

설치가 이루어진 뒤, *역할 및 기능 추가 마법사* **닫기** 버튼을 누르면 위와 같이 *알림* 메뉴에서 **서버를 다시 시작**해야 한다고 알린다.

**계획됨**을 선택하여 시스템일 재부팅한다.

<br>

재부팅이 완료되면 다음처럼 진행한다.

![Hyper-V 관리자 위치](/assets/img/2024-04-22/13.png)
_Hyper-V 관리자 위치_

*도구* 탭의 **Hyper-V 관리자** 메뉴를 선택하거나, Window + R키로 실행창에서 `virtmgmt.msc`를 입력한다.

<br>

![Hyper-V 가상 스위치 관리자 위치](/assets/img/2024-04-22/14.png)
_Hyper-V 가상 스위치 관리자 위치_

이후 현재 켜져있는 서버를 우측 마우스 클릭 -> **가상 스위치 관리자** 메뉴를 선택한다.

<br>

**새 가상 네트워크 스위치**에서 *외부*, *내부*, *개인*을 선택해 총 3개의 스위치를 생성한다.

![Hyper-V 가상 스위치 관리자 - 가상 네트워크 스위치 추가](/assets/img/2024-04-22/15.png)
_Hyper-V 가상 스위치 관리자 - 가상 네트워크 스위치 추가_

<br>

![Hyper-V 가상 스위치 추가 완료](/assets/img/2024-04-22/16.gif)
_Hyper-V 가상 스위치 추가 완료_

위 상태와 같이 가상 스위치들을 추가 완료하였다.

<br>

![Hyper-V 가상 스위치 - External IP 설정](/assets/img/2024-04-22/17.gif)
_Hyper-V 가상 스위치 - External IP 설정_

외부와 연결된 가상 스위치를 직접 IP를 설정한다.

<br>

SVR2도 같은 과정으로 진행한다.

그 이후, Domain Controller가 관리할 수 있도록 **Domain에 가입**한다. 반드시 필요한 과정이니 잊지 않고 진행한다.

또한, 로컬 계정이 아닌 **도메인 관리자 계정**으로 접속하도록 하자. ~~물론 일반적인 상황은 아니나, 실습이 원활하게 이루어지도록 관리자 계정으로 접속하는 것이다.~~

![Hyper-V 호스트 - 도메인 로그인](/assets/img/2024-04-22/18.gif)
_Hyper-V 호스트 - 도메인 로그인_

<br>

---

### 가상 컴퓨터 생성

<br>

이제 Linux와 Window Server 2003의 가상 하드디스크를 생성한다.

**sysprep**이라는 개념이 등장하는데, 이것은 윈도우 가상머신의 신속한 배포를 위해 미리 준비하는 것으로 *System Preparation*의 약자이다.

Windows의 Domain Controller는 각 컴퓨터들을 SID라는 고유한 보안 식별자로 구분하는데, 이것이 같은 경우 도메인에 가입이 안되기 때문이다.

<br>

![Hyper-V 관리자 - 가상 하드디스크 추가 위치](/assets/img/2024-04-22/19.png)
_Hyper-V 관리자 - 가상 하드디스크 추가 위치_

새로운 가상 하드디스크를 추가한다.

![Hyper-V 관리자 - 가상 하드디스크 추가 1](/assets/img/2024-04-22/20.png)
_Hyper-V 관리자 - 가상 하드디스크 추가 1_

<br>

![Hyper-V 관리자 - 가상 하드디스크 추가 2](/assets/img/2024-04-22/21.png)
_Hyper-V 관리자 - 가상 하드디스크 추가 2_

VHD보다 발전된 형태의 **VHDX 형식**으로 가상 하드디스크를 생성하겠다.

<br>

![Hyper-V 관리자 - 가상 하드디스크 추가 3](/assets/img/2024-04-22/22.png)
_Hyper-V 관리자 - 가상 하드디스크 추가 3_

*고정 크기*가 실질적인 성능은 뛰어나지만 공간을 잡는 만큼 해당 용량을 차지하기 때문에 선택하지 않고, **동적 확장**을 선택하고 **다음** 버튼을 누른다.

<br>

![Hyper-V 관리자 - 가상 하드디스크 추가 4](/assets/img/2024-04-22/23.png)
_Hyper-V 관리자 - 가상 하드디스크 추가 4_

이전에 미리 설정해뒀던 가상 하드디스크가 저장되는 장소로 **win2003-1.vhdx** 가상 하드디스크를 생성한다.

<br>

![Hyper-V 관리자 - 가상 하드디스크 추가 5](/assets/img/2024-04-22/24.png)
_Hyper-V 관리자 - 가상 하드디스크 추가 5_

*비어 있는 새 가상 하드 디스크 만들기*를 선택하고 **20GB**를 입력하고 **다음** 버튼을 누른다. *동적 디스크*이기 때문에, 20GB 전부를 차지하지는 않을 것이다. -> 이후 **마침** 버튼을 누른다.

<br>

이제 새로운 가상 컴퓨터를 생성한다.

![Hyper-V 관리자 - 가상 컴퓨터 생성 위치](/assets/img/2024-04-22/25.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 위치_

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 1](/assets/img/2024-04-22/26.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 1_

**다음** 버튼을 누른다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 2](/assets/img/2024-04-22/27.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 2_

**win2003-1**이라는 이름으로 가상 컴퓨터를 생성하겠다고 지정하고, **다음** 버튼을 누른다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 3](/assets/img/2024-04-22/28.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 3_

**1세대**를 선택하고, **다음** 버튼을 누른다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 4](/assets/img/2024-04-22/29.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 4_

메모리를 **512MB**로 설정하고, **다음** 버튼을 누른다.

메모리는 VMware를 실행한 호스트 OS의 실제 메모리에 기반하여 적절한 양을 선택해야 한다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 5](/assets/img/2024-04-22/30.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 5_

외부 인터넷과 통신을 하기 위해 VMnet8과 동일한 대역인 192.168.1.X 대역의 IP인 **External**을 선택하고 **다음** 버튼을 누른다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 6](/assets/img/2024-04-22/31.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 6_

아까 생성했던 가상 하드디스크를 지정하고, **다음** 버튼을 누른다.

![Hyper-V 관리자 - 가상 컴퓨터 생성 완료](/assets/img/2024-04-22/32.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 완료_

**마침** 버튼을 누른다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 생성 확인](/assets/img/2024-04-22/33.png)
_Hyper-V 관리자 - 가상 컴퓨터 생성 확인_

가상 컴퓨터가 생성된 것을 확인할 수 있다.

이제 OS 이미지 파일을 마운트시키고 부팅하면 설치가 시작된다.

<br>

![Hyper-V 관리자 - 가상 컴퓨터 설정 위치](/assets/img/2024-04-22/34.png)
_Hyper-V 관리자 - 가상 컴퓨터 설정 위치_

마운트 시키기 위해 가상 컴퓨터의 설정을 조작한다.

![Hyper-V 관리자 - 가상 컴퓨터 이미지 마운트](/assets/img/2024-04-22/35.png)
_Hyper-V 관리자 - 가상 컴퓨터 이미지 마운트_

위 사진처럼 필요한 이미지를 마운트하고, 부팅하면 설치가 진행된다.

설치가 다 진행되었다고 가정한다. 이제 신속한 배포를 위해 **sysprep**을 생성할 것이다.

<br>

![Hyper-V - 가상 컴퓨터 sysprep 1](/assets/img/2024-04-22/36.png)
_Hyper-V - 가상 컴퓨터 sysprep 1_

이미지 파일이 마운트된 디스크를 **열기**를 눌러 들어온 상태이다. **SUPPORT** 폴더 안으로 들어간다.

![Hyper-V - 가상 컴퓨터 sysprep 2](/assets/img/2024-04-22/37.png)
_Hyper-V - 가상 컴퓨터 sysprep 2_

**TOOLS** 폴더 안으로 들어간다.

<br>

![Hyper-V - 가상 컴퓨터 sysprep 3](/assets/img/2024-04-22/38.png)
_Hyper-V - 가상 컴퓨터 sysprep 3_

**DEPLOY.CAB**을 더블 클릭한다.

<br>

![Hyper-V - 가상 컴퓨터 sysprep 4](/assets/img/2024-04-22/39.png)
_Hyper-V - 가상 컴퓨터 sysprep 4_

모든 파일을 *드래그로 선택*하고 *오른쪽 마우스 클릭* 후, **압축 풀기** 메뉴를 선택한다.

<br>

![Hyper-V - 가상 컴퓨터 sysprep 5](/assets/img/2024-04-22/40.png)
_Hyper-V - 가상 컴퓨터 sysprep 5_

C 드라이브 아래에 **sysprep**이라는 폴더를 생성한 뒤, 선택하고 **압축 풀기** 버튼을 누른다.

<br>

이제 선택했던 파일들이 *sysprep* 폴더 안에 압축이 풀렸을 것이다.

해당 폴더로 이동하면 다음과 같은 상태이다.

![Hyper-V - 가상 컴퓨터 sysprep 6](/assets/img/2024-04-22/41.png)
_Hyper-V - 가상 컴퓨터 sysprep 6_

**sysprep.exe** 파일을 실행한다.

![Hyper-V - 가상 컴퓨터 sysprep 7](/assets/img/2024-04-22/42.png)
_Hyper-V - 가상 컴퓨터 sysprep 7_

**확인** 버튼을 누른다.

<br>

![Hyper-V - 가상 컴퓨터 sysprep 8](/assets/img/2024-04-22/43.png)
_Hyper-V - 가상 컴퓨터 sysprep 8_

**다시 봉인** 버튼을 누른다.

![Hyper-V - 가상 컴퓨터 sysprep 완료](/assets/img/2024-04-22/44.png)
_Hyper-V - 가상 컴퓨터 sysprep 완료_

*보안 ID(SID)*를 다시 생성하여 동일한 값이 생길 수 없도록 한다.

잠시 기다리면 컴퓨터가 종료된다.

지금 상태에서 해당 디스크를 복사하면 부팅할 때마다 새로운 SID를 생성하며 신속한 배포가 가능한 상태가 된다.

> 최신 OS의 경우 Window + R키 -> 실행창에서 `sysprep`을 입력하면 바로 시스템 준비도구를 실행시키는 폴더가 열린다. 즉, 최신 OS가 좀 더 수월하고 빠르게 가상머신들을 배포할 수 있다.
{: .prompt-info }

> **SID**를 확인하려면 *명령 프롬프트*에서 `whoami /user` 명령어를 입력해서 확인할 수 있다.
{: .prompt-tip }

<br>

![SVR1 가상 하드디스크 상태](/assets/img/2024-04-22/45.png)
_SVR1 가상 하드디스크 상태_

현재 만들어진 **sysprep**을 복사하여 Windows Server 2003이 설치된 하드디스크 2개가 준비되어 있다.

DC1에도 1개를 복사하여 공유받은 하드디스크를 통해 가상머신을 부팅시킬 것이다.

![DC1 가상 하드디스크 상태](/assets/img/2024-04-22/46.png)
_DC1 가상 하드디스크 상태_

아직 공유를 진행하지는 않았지만, `C:\smb\win2003-3.vhdx`{:.filepath}라는 폴더와 sysprep을 준비했다.

<br>

![DC1 공유 폴더 설정 1](/assets/img/2024-04-22/47.png)
_DC1 공유 폴더 설정 1_

**sysprep**이 들어있는 폴더를 네트워크 공유를 통해서 각 Hyper-V 호스트들이 접근할 수 있도록 한다.

*공유* 탭에서 **고급 공유** 버튼을 누른다.

<br>

![DC1 공유 폴더 설정 2](/assets/img/2024-04-22/48.png)
_DC1 공유 폴더 설정 2_

**선택한 폴더 공유**를 체크하고, **권한** 버튼을 누른다.

![DC1 공유 폴더 설정 3](/assets/img/2024-04-22/49.png)
_DC1 공유 폴더 설정 3_

*Everyone* 그룹에게 모든 권한을 부여한다. *Everyone* 그룹은 익명 사용자도 포함하는 그룹으로 보안 상 허용하면 안되는 그룹이지만, 현재 사설망에 존재하는 가상머신이며 실습임을 감안해 진행한다.

<br>

---

SVR1에는 `win2003-1`{:.filepath}, `win2003-2`{:.filepath}, `win2003-3`{:.filepath}을 생성하고, 각각의 CD-ROM에는 Windows Server 2003 이미지 파일을 마운트하여 부팅하도록 한다.

![가상 컴퓨터 생성 1](/assets/img/2024-04-22/50.png)
_가상 컴퓨터 생성 1_

부팅시키고 기다리다보면 위 사진과 같은 상태가 된다. **다음** 버튼을 눌러 진행한다.

이후 약관 동의를 진행하고, 시리얼 번호를 입력하는 등의 과정이 진행된다.

<br>

![가상 컴퓨터 생성 2](/assets/img/2024-04-22/51.png)
_가상 컴퓨터 생성 2_

사용자의 이름을 지정하고, 이어서 진행하다보면 컴퓨터의 이름도 지정한다. 암호의 경우 *sysprep*을 봉인하기 전 입력했던 암호가 설정되어있어서 암호를 지정하지 않아도 기본 비밀번호로 설정된다.

![가상 컴퓨터 생성 3](/assets/img/2024-04-22/52.png)
_가상 컴퓨터 생성 3_

<br>

![가상 컴퓨터 생성 완료](/assets/img/2024-04-22/53.png)
_가상 컴퓨터 생성 완료_

Windows Server 2003의 상세한 설치 과정은 생략하고, SVR1에 존재하는 `win2003-1`{:.filepath}, `win2003-2`{:.filepath}과, DC1에서 공유받은 폴더에 있는 가상 하드디스크로 부팅한 `win2003-3`{:.filepath}을 모두 설치한 상태이다.

<br>

---

#### Hyper-V 설정

<br>

`win2003-1`{:.filepath}은 NAT 서버로 활용하기 위해 네트워크 어댑터를 총 3개 장착시키고, `win2003-2`{:.filepath}, `win2003-3`{:.filepath}은 사설망에 구축해 처음엔 통신이 불가능하지만 NAT 서버에서 *라우팅 및 원격 액세스*를 구성하여 서로 통신이 가능하도록 한다.

`win2003-2`{:.filepath}에 Telnet 서버를 구축하고, `win2003-3`{:.filepath}에는 원격 데스크톱이 가능하도록 `win2003-1`{:.filepath}에서 NAT 포트포워딩을 통해 ~~가상의~~ 외부 인터넷에서 접속할 수 있도록 한다.

`win2003-2`{:.filepath}는 10.10.10.0/24 대역에 존재하고, `win2003-3`{:.filepath}는 10.10.20.0/24 대역에 존재해 서로 통신이 불가능한 상태로 설정할 것이며, `win2003-1`{:.filepath}에 추가되는 2개의 네트워크 어댑터는 10.10.10.0/24 대역과 10.10.20.0/24 대역의 게이트웨이 역할을 할 것이다.

그러기 위해서는 *가상 스위치 관리자*에서 새로운 **내부** 네트워크를 추가해야 한다. 해당 메뉴의 위치는 다음과 같다.

![Hyper-V 가상 스위치 관리자 위치](/assets/img/2024-04-22/54.png)
_Hyper-V 가상 스위치 관리자 위치_

둘 중 하나를 눌러서 진행한다.

<br>

![Hyper-V 가상 스위치 관리자 - 새 가상 네트워크 스위치 추가](/assets/img/2024-04-22/55.png)
_Hyper-V 가상 스위치 관리자 - 새 가상 네트워크 스위치 추가_

처음 설정할 때 만들어뒀던 외부, 내부, 개인 네트워크 스위치들 외에 새로운 **내부** 네트워크 스위치를 추가한다.

<br>

![Hyper-V 가상 스위치 관리자 - Internal2 내부 스위치 추가](/assets/img/2024-04-22/56.png)
_Hyper-V 가상 스위치 관리자 - Internal2 내부 스위치 추가_

추가되는 가상 스위치의 이름을 "Internal2"로 설정하고 **확인** 혹은 **적용**을 누른다.

<br>

이제 NAT 서버(`win2003-1`{:.filepath})에 네트워크 어댑터를 2개 추가한다. 그러기 위한 메뉴의 위치는 다음과 같다.

![Hyper-V 설정 - 위치](/assets/img/2024-04-22/57.png)
_Hyper-V 설정 - 위치_

둘 중 하나를 눌러서 진행할 수 있다. 

<br>

![Hyper-V 설정 - 가상 네트워크 스위치 추가 진행](/assets/img/2024-04-22/58.gif)
_Hyper-V 설정 - 가상 네트워크 스위치 추가 진행_

위와 같이 진행하면 3개의 NIC(Network Interface Controller)을 장착한 것과 같다.

<br>

*가상 스위치 관리자*에서 진행했던 과정을 통해 SVR1 네트워크 어댑터에 변화가 생겼다. 확인해본다.

![가상 스위치 추가로 인한 SVR1 네트워크 연결 변화](/assets/img/2024-04-22/59.gif)
_가상 스위치 추가로 인한 SVR1 네트워크 연결 변화_

vEthernet이 추가된 것을 확인할 수 있다.

<br>

위에서 진행한 것처럼 `win2003-2`{:.filepath}의 네트워크 어댑터는 "Internal"과 연결하고, `win2003-3`{:.filepath}의 네트워크 어댑터는 "Internal2"와 연결한다.

`win2003-2`{:.filepath}의 네트워크 어댑터가 "Internal"인 것을 확인하고, 연결 후 부팅을 시작한다.

![win2003-2 가상 컴퓨터 시작](/assets/img/2024-04-22/60.gif)
_win2003-2 가상 컴퓨터 시작_

<br>

`win2003-2`{:.filepath}의 IP를 설정한다.

![win2003-2 IP 설정](/assets/img/2024-04-22/61.gif)
_win2003-2 IP 설정_

위와 같은 과정을 반복하며, `win2003-3`{:.filepath}의 네트워크 어댑터는 "Internal2"인지 확인하고 부팅 후 IP를 설정한다.

<br>

`win2003-2`{:.filepath}와 `win2003-3`{:.filepath}는 서로 다른 대역의 네트워크여서 통신이 불가능한지 테스트한다. 분명히 되지 않을 것이다.

![win2003-2, win2003-3 통신 확인](/assets/img/2024-04-22/62.gif)
_win2003-2, win2003-3 통신 확인_

통신이 불가능한 것을 확인했다. 아직 `win2003-1`{:.filepath}에서 게이트웨이 IP를 설정하지 않았을 뿐더러, NAT 기능(라우터 기능 포함)을 구성하지 않았기 때문이다.

<br>

---

### NAT 구성

<br>

이제 `win2003-1`{:.filepath}에서 네트워크 연결을 설정한다.

- Public(External)

    - IP : 192.168.1.111/24

    - GW : 192.168.1.2

    - DNS : 8.8.8.8

- GW1(Internal)

    - IP : 10.10.10.1/24

- GW2(Internal2)

    - IP : 10.10.20.1/24

주의할 점은 가상 네트워크 스위치의 MAC 주소를 잘 확인하고 설정해야 한다. MAC 주소를 확인하는 방범은 다음을 참고한다.

![win2003-1 MAC 주소 확인](/assets/img/2024-04-22/63.gif)
_win2003-1 MAC 주소 확인_

`ipconfig /all` 명령어를 명령 프롬프트에서 입력해 MAC 주소를 포함한 NIC의 많은 정보를 확인할 수 있다.

<br>

![win2003-1 네트워크 연결 상태](/assets/img/2024-04-22/64.png)
_win2003-1 네트워크 연결 상태_

IP 및 네트워크 연결의 이름을 변경한 상태이다. 

<br>

위와 같이 설정한 뒤, *라우팅 및 원격 액세스*를 통해 NAT 서버의 역할을 구성한다.

![라우팅 및 원격 액세스 메뉴 위치](/assets/img/2024-04-22/65.png)
_라우팅 및 원격 액세스 메뉴 위치_

![라우팅 및 원격 액세스 구성 및 사용](/assets/img/2024-04-22/66.png)
_라우팅 및 원격 액세스 구성 및 사용_

*이 컴퓨터의 이름*을 마우스 우클릭해 메뉴를 켜고, **라우팅 및 원격 액세스 구성 및 사용** 메뉴를 선택한다.

<br>

![라우팅 및 원격 액세스 구성 및 사용 설정 진행](/assets/img/2024-04-22/67.gif)
_라우팅 및 원격 액세스 구성 및 사용 설정 진행_

*다음* -> **네트워크 주소 변환(NAT)** -> 외부 인터넷과 연결된 **Public** 선택 후, **기본 방화벽 사용 해제** -> *다음* -> *다음* -> *다음* -> *다음* -> *마침* 버튼 순으로 진행한다.

이제 내부 네트워크에서 통신이 가능해진다.

간단한 테스트를 진행한다.

![win2003-2, win2003-3 통신 가능](/assets/img/2024-04-22/68.gif)
_win2003-2, win2003-3 통신 가능_

이제 기본적인 설정이 끝났다.

<br>

---

#### Windows Server 2003 Telnet 서비스 설정

<br>

![win2003-2 Telnet 서비스 활성화](/assets/img/2024-04-22/69.gif)
_win2003-2 Telnet 서비스 활성화_

실행창에서 `services.msc` 명령어로 *서비스* 창을 띄운 뒤, "t" 입력해 't'로 시작하는 서비스로 바로 이동할 수 있다.

Telnet을 우클릭 한 뒤, **속성** -> *시작 유형*을 *사용 안 함*에서 **자동**으로 변경 -> **적용** -> **시작** -> *확인* 순으로 진행한다.

그 이후, cmd에서 23번 포트가 "LISTENING" 상태로 변한 것을 확인할 수 있다.

<br>

이제 Telnet 서비스를 사용할 유저를 생성하고, 해당 유저를 *TelnetClients* 그룹의 구성원으로 포함시켜야 한다.

![로컬 사용자 및 그룹 - 사용자 추가 및 그룹 구성원 추가](/assets/img/2024-04-22/70.gif)
_로컬 사용자 및 그룹 - 사용자 추가 및 그룹 구성원 추가_

실행창 `lusrmgr.msc` -> *사용자* -> *teluser* 생성 -> *그룹* -> **TelnetClients** 그룹 -> 구성원으로 해당 사용자 추가 순으로 진행한다.

<br>

---

#### Windows Server 2003 Telnet 원격 데스크톱 연결

<br>

![win2003-3 원격 데스크톱 연결 포트 변경 및 활성화](/assets/img/2024-04-22/71.gif)
_win2003-3 원격 데스크톱 연결 포트 변경 및 활성화_

서비스가 활성화되지 않은 상태에서 3389번 포트를 사용하는 서비스가 없는지 확인했다.

그 이후 레지스트리 편집기에서 *원격 데스크톱 연결*에서 사용하는 포트 번호를 검색한다. 다음 찾기는 `F3` 키를 입력해서 진행할 수 있다.

16진수로 적혀있는 정수를 10진수로 변환하니 3389가 확인되며, 이를 35000번으로 변경한 뒤 **원격 데스크톱 연결**을 활성화할 수 있는 메뉴가 있는 곳으로 이동한다.

*내 컴퓨터*를 오른쪽 마우스 클릭 -> **속성** -> *원격* 탭 -> *원격 데스크톱* 메뉴에서 **이 컴퓨터에서 원격 데스크톱 사용** 체크 -> *적용* 순으로 진행한다.

그 이후, 3389번 포트가 대기중인지 확인 -> 35000번 대기중인지 확인한다.

<br>

---

#### NAT 포트포워딩 

<br>

![NAT 포트포워딩 설정 위치](/assets/img/2024-04-22/72.png)
_NAT 포트포워딩 설정 위치_

해당 컴퓨터 확장 -> *IP 라우팅* 확장 -> **NAT/기본 방화벽** -> **Public** 마우스 오른쪽 클릭 -> **속성** 순으로 진행한다.

<br>

Telnet 서비스는 그대로 진행할 수 있지만, 기존에 존재하는 *원격 데스크톱*은 3389 포트를 변경할 수 없기 때문에, **추가** 버튼을 눌러야 한다.

![NAT 포트포워딩 설정 진행](/assets/img/2024-04-22/73.gif)
_NAT 포트포워딩 설정 진행_

위와 같이 설정하면 NAT 포트포워딩이 모두 완료된다. 이제 ~~가상의 외부 인터넷인~~ 호스트 OS에서 접속해보자.

<br>

---

##### 테스트 - Telnet 접속

<br>

![Telnet 접속 테스트](/assets/img/2024-04-22/74.gif)
_Telnet 접속 테스트_

Telnet 접속을 테스트 완료했다.

---

##### 테스트 - 원격 데스크톱 연결

<br>

![원격 데스크톱 연결 테스트](/assets/img/2024-04-22/75.gif)
_원격 데스크톱 연결 테스트_

원격 데스크톱 연결 테스트를 완료했다.

---

### VLAN 구성

<br>

모든 가상 네트워크 스위치를 "External"으로 전환한 뒤, win2003-2와 win2003-3에 각각 VLAN ID를 부여한다.

추후 진행한다..